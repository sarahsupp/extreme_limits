Model Weight Variation
========================================================

This document describes the model of Weight observed in Arizona and how it covaries with energetic demand and resource availability in Mexican wintering grounds

```{r}
#load the Hummingbird data; i.e. the d.f. site.dat
load("/Users/mcwlim/Desktop/GitHub/extreme_limits/data/site.dat.rdata")
```

How does weight vary with fat?
```{r}
#fat classes 0 and P can be lumped
site.dat$Fat[site.dat$Fat=="P"] <- 0
orderfat <- function(x){ordered(x, levels=c(0, "T" ,1:3))}
site.dat$Fat <- orderfat(site.dat$Fat)
plot(site.dat$Weight ~ site.dat$Fat, col="light grey", xlab = "Fat", ylab = "Weight", 
     pch=19, cex.axis = 2, cex.lab = 2)

mean(site.dat$Weight, na.rm=T)
range(site.dat$Weight, na.rm=T)
sd(site.dat$Weight, na.rm=T)

fatscores <- table(site.dat$Fat)
fatscores[1] / sum(fatscores)
fatscores[3] / sum(fatscores)
```

Weight does not strongly vary with molt
````{r}
ordermolt <- function(x){ordered(toupper(x), levels=c("M","R",1:8,0,9,"F","L"))}
site.dat$PriMary.Molt <- ordermolt(site.dat$PriMary.Molt)
plot(site.dat$Weight ~ site.dat$PriMary.Molt, col="light grey", pch=19, 
     xlab = "Primary Molt", ylab = "Weight", cex.axis = 2, cex.lab = 2)
````

FYI: How are observations distributed across Molt classes?
```{r}
table(site.dat$PriMary.Molt)
````


Which pairs of primary molt classes differ in weight?
````{r}
tt<-round(sort(TukeyHSD(aov(site.dat$Weight ~ site.dat$PriMary.Molt))[[1]][,4]), 3)
tt[tt<0.2]
````

Which pairs of secondary molt classes differ in weight?
````{r}
site.dat$Secondary.Molt <- ordermolt(site.dat$Secondary.Molt)
plot(site.dat$Weight ~ site.dat$Secondary.Molt, col="light grey", xlab = "Secondary Molt Class", ylab = "Weight",
     , cex.axis = 2, cex.lab = 2, pch=19)
table(site.dat$Secondary.Molt)
tt<-round(sort(TukeyHSD(aov(site.dat$Weight ~ site.dat$Secondary.Molt))[[1]][,4]), 3)
tt[tt<.2]
````

Which pairs of body molt classes differ in weight?
````{r}
site.dat$Body.Molt <- ordermolt(site.dat$Body.Molt)
plot(site.dat$Weight ~ site.dat$Body.Molt, col="light grey", xlab="Body Molt Class", ylab="Weight", pch=19, 
     cex.lab = 2, cex.axis = 2)
table(site.dat$Body.Molt)
tt<-round(sort(TukeyHSD(aov(site.dat$Weight ~ site.dat$Body.Molt))[[1]][,4]),3)
tt[tt<.2]
````

Which pairs of gorget/head molt classes differ in weight?
````{r}
site.dat$Gorget.head.molt <- ordermolt(site.dat$Gorget.head.molt)
plot(site.dat$Weight ~ site.dat$Gorget.head.molt, col="light grey",xlab="gorget head molt", ylab="Weight", pch=19, 
     cex.lab = 2, cex.axis = 2)
table(site.dat$Gorget.head.molt)
tt<-round(sort(TukeyHSD(aov(site.dat$Weight ~ site.dat$Gorget.head.molt))[[1]][,4]),3)
tt[tt<.2]
````

Which pairs of tail molt classes differ in weight?
````{r}
site.dat$Tail.Molt <- ordermolt(site.dat$Tail.Molt)
plot(site.dat$Weight ~ site.dat$Tail.Molt, col="light grey", xlab="tail molt", ylab="Weight", pch=19, 
     cex.lab = 2, cex.axis = 2)
table(site.dat$Tail.Molt)
tt<-round(sort(TukeyHSD(aov(site.dat$Weight ~ site.dat$Tail.Molt))[[1]][,4]),3)
tt[tt<.2]
```

Keep only the variables you need for the modelling analysis
```{r}
site.dat <- site.dat[,c("LOC", "Weight", "Fat", "yearfac", "mofac")]
```

Load the yearly climate (and NDVI) data which will serve as predictors and merge it with the weight metrics in the data frame 'yearly.weight.stat' to be used for modelling
````{r}
load("/Users/mcwlim/Desktop/GitHub/extreme_limits/data/yearly.climate.rdata")
#gives you yearly.climate
yearly.weight.stat <- merge(x=site.dat, y=yearly.climate, by.x='yearfac', by.y='yr')
rm(site.dat, yearly.climate)
````

Plot molt responses to a proxy for physiological (yearly.Te.10C.q) demand and resource availability (NDVI)
```{r fig.width=7, fig.height=6, warning=FALSE}
require(lattice)
require(latticeExtra)
xyplot(Weight ~ yearly.Te.10C.q|LOC, data=yearly.weight.stat) + layer(panel.smoother(x, y, method = "lm"))
xyplot(Weight ~ winterNDVI|LOC, data=yearly.weight.stat) + layer(panel.smoother(x, y, method = "lm"))

xyplot(Fat ~ yearly.Te.10C.q|LOC, data=yearly.weight.stat) + layer(panel.smoother(x, y, method = "lm"))
xyplot(Fat ~ winterNDVI|LOC, data=yearly.weight.stat) + layer(panel.smoother(x, y, method = "lm"))

xyplot(Weight ~ yearly.Te.10C.q, data=yearly.weight.stat) + layer(panel.smoother(x, y, method = "lm"))
xyplot(Weight ~ winterNDVI, data=yearly.weight.stat) + layer(panel.smoother(x, y, method = "lm"))

xyplot(Fat ~ yearly.Te.10C.q, data=yearly.weight.stat) + layer(panel.smoother(x, y, method = "lm"))
xyplot(Fat ~ winterNDVI, data=yearly.weight.stat) + layer(panel.smoother(x, y, method = "lm"))

```


GGPLOT VERSION: Plot molt responses to a proxy for physiological (yearly.Te.10C.q) demand and resrouce availability (NDVI)
```{r fig.width=7, fig.height=6, warning=FALSE}
require(ggplot2)
require(gridExtra)

ggplot(yearly.weight.stat[complete.cases(yearly.weight.stat),], aes(yearly.Te.10C.q, Weight)) + geom_point() + theme_bw() + facet_wrap(~LOC) + stat_smooth(method="lm", aes(group=1)) + ylab("body mass (grams)")

ggplot(yearly.weight.stat[complete.cases(yearly.weight.stat),], aes(winterNDVI, Weight)) + geom_point() + 
  theme_bw() + facet_wrap(~LOC) + stat_smooth(method="lm", aes(group=1)) + ylab("body mass(grams)")

ggplot(yearly.weight.stat[complete.cases(yearly.weight.stat),], aes(yearly.Te.10C.q, Fat)) + geom_point() + theme_bw() + facet_wrap(~LOC) + stat_smooth(method="lm", aes(group=1)) + ylab("fat score")

ggplot(yearly.weight.stat[complete.cases(yearly.weight.stat),], aes(winterNDVI, Fat)) + geom_point() + 
  theme_bw() + facet_wrap(~LOC) + stat_smooth(method="lm", aes(group=1)) + ylab("fat score")

#overall response
p3 <- ggplot(yearly.weight.stat[complete.cases(yearly.weight.stat),], aes(yearly.Te.10C.q, Weight)) + geom_point() + theme_classic() + theme(text = element_text(size=15)) + stat_smooth(method="lm", aes(group=1), col="black") + ylab("Body mass\n (grams)\n") + xlab("")

p4 <- ggplot(yearly.weight.stat[complete.cases(yearly.weight.stat),], aes(winterNDVI, Weight)) + geom_point() + theme_classic() + theme(text = element_text(size=15)) + stat_smooth(method="lm", aes(group=1), col="black") + ylab("") + xlab("")

p5 <- ggplot(yearly.weight.stat[complete.cases(yearly.weight.stat),], aes(yearly.Te.10C.q, Fat)) + geom_point() + theme_classic() + theme(text = element_text(size=15)) + stat_smooth(method="lm", aes(group=1), col="black") + ylab("Fat score\n") + xlab("")

p6 <- ggplot(yearly.weight.stat[complete.cases(yearly.weight.stat),], aes(winterNDVI, Fat)) + geom_point() + theme_classic() + theme(text = element_text(size=15)) + stat_smooth(method="lm", aes(group=1), col="black") + ylab("") + xlab("")

# Run Weight_model_ml.Rmd, Molt_model_ml.Rmd, and Arrival_model_ml.Rmd to get all the plots and then use grid.arrange to plot them all together.
jpeg("C:/Users/mcwlim/Dropbox/NASA_Hummingbirds/P4_ExtremeEvents_Susan/P4_Paper_drafts/paper_figures/overallresponses_bw.jpg", height=10, width=8, units="in", res=500)
grid.arrange(p1, p2, p3, p4, p5, p6, p7, p8, ncol=2)
dev.off()

```


Load a function ('mod.evaluation') to evaluate hierarchical models
````{r}
source('/Users/mcwlim/Desktop/GitHub/extreme_limits/Model_evaluation_v4_ml.r')
````

Using aforementioned function evaluate hierarchical models of WEIGHT as a linear function of annual physiological demand and resource availability, allowing for a random intercept associated with 'site' 
```{r}
attach(yearly.weight.stat)
#http://www.quantpsy.org/interact/interactions.htm
mod.evaluation(yname='Weight', centering='CGM', stand=T, ordered.fac.treatment = "as.num", log.D=T, 
               R="winterNDVI", D="yearly.Te.10C.q", N=NULL)
detach(yearly.weight.stat)
```

Using the function evaluate hierarchical models of FAT as a linear function of annual physiological demand and resource availability, allowing for a random intercept associated with 'site' 
```{r}
attach(yearly.weight.stat)
#http://www.quantpsy.org/interact/interactions.htm
mod.evaluation(yname='Fat', centering='CGM', stand=T, ordered.fac.treatment = "as.num", log.D=T, 
               R="winterNDVI", D="yearly.Te.10C.q", N=NULL)
detach(yearly.weight.stat)
```

